---
title: "ausplotsR: quickstart guide to basic analysis of TERN AusPlots vegetation data"
author: "Greg Guerin"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ausplotsR: quickstart guide to basic analysis of TERN AusPlots vegetation data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction

TERN AusPlots is a national plot-based terrestrial ecosystem surveillance monitoring method and dataset for Australia. Through ausplotsR, users can directly access AusPlots data collected by on-ground observers on vegetation and soils, including physical sample/voucher details and barcode numbers. The dataset can be downloaded in its entirety or as individual modules, and can be subsetted by geographic bounding box or species name search. The package also includes a series of bespoke functions for working with AusPlots data, including visualisation, creating tables of species composition, and calculation of tree basal area, fractional cover or vegetation cover by growth form/structure/strata and so on.

This is a short guide for getting started with analysis of AusPlots data through the ausplotsR R package. More information on making use of AusPlots data in ausplotsR is available through the package help files and manual. Below, we demonstrate installing the package, accessing some AusPlots data, generating matrices and running simple example analysis.

More comprehensive tutorials on accessing and analysing AusPlots data are available at:
[https://github.com/ternaustralia/TERN-Data-Skills/tree/master/EcosystemSurveillance_PlotData](https://github.com/ternaustralia/TERN-Data-Skills/tree/master/EcosystemSurveillance_PlotData)


## Installing the package and accessing raw data

The latest versions of ausplotsR can be installed directly from github using the `devtools` package, which must be installed first.

```
library(devtools)
install_github("ternaustralia/ausplotsR", build_vignettes = TRUE, dependencies = TRUE)
```

Once installed, load the package.

```{R, warning=FALSE, message=FALSE, error=FALSE}
library(ausplotsR)
```

We can now access live data, starting here with basic site information and vegetation point-intercept modules and using a bounding box to spatially filter the dataset to central Australia.

```{r}
#see ?get_ausplots to explore all data modules available
my.ausplots.data <- get_ausplots(veg.vouchers = FALSE, bounding_box = c(125, 140, -40, -10))
```

The output of the above call is a list with the following $elements:

```{r}
names(my.ausplots.data)
```

The 'site.info' table contains basic site and visit details and can be used to identify or subset surveys in space and time, for example: 

```{r}
#count plot visits per Australian States:
summary(as.factor(my.ausplots.data$site.info$state))
```


##Map AusPlots sites and visualise data

The package has an in-built function - see `?ausplots_visual` - to visualise the sites on a map of Australia. Maps can also be generated manually using the longitude and latitude fields in the site.info table.

```{r fig1, fig.height = 4, fig.width = 6}
map_ausplots(my.ausplots.data)
```

## Example 1: latitudinal pattern in proportional vegetation cover

Let's visualise vegetation cover as a function of latitude. First, we call the `fractional_cover` function on the extracted point-intercept data (`$veg.PI`). Note the calculation may take a few minutes for many AusPlots, so for this example we will pull out a subset of 100 randomly drawn sites to work with.

```{r,warning=FALSE}
my.fractional <- fractional_cover(my.ausplots.data$veg.PI[which(my.ausplots.data$veg.PI$site_unique %in% sample(my.ausplots.data$site.info$site_unique, 100)), ])
head(my.fractional)
```

Next, we need to merge the fractional cover scores with longlat coordinates from the site information table. Each survey is identified by the 'site_unique' field, which is unique combination of site ID ('site_location_name') and visit ID ('site_location_visit_id'). The 'site_unique' field therefore links all tables returned from the get_ausplots function:

```{r}
my.fractional <- merge(my.fractional, my.ausplots.data$site.info, by="site_unique")[,c("site_unique", "bare", "brown", "green", "NA.", "longitude", "latitude")]
my.fractional <- na.omit(my.fractional)
head(my.fractional)
```

Now we can plot out the continental relationship, e.g., between the proportion of bare ground with no kind of vegetation cover above and latitude.

```{r, fig.height = 4, fig.width = 6}
plot(bare ~ latitude, data=my.fractional, pch=20, bty="l")
```

There appears to be a hump-backed relationship, with a higher proportion of bare ground in the arid inland at mid-latitudes. We can add a simple quadratic model to test/approximate this:

```{r, fig.height = 4, fig.width = 6}
my.fractional$quadratic <- my.fractional$latitude^2

LM <- lm(bare ~ latitude + quadratic, data=my.fractional)
summary(LM)

#generate predicted values for plotting:
ND <- data.frame(latitude=seq(from=min(my.fractional$latitude), to=max(my.fractional$latitude), length.out=50), quadratic=seq(from=min(my.fractional$latitude), to=max(my.fractional$latitude), length.out=50)^2)
ND$predict <- predict(LM, newdata=ND)
#
plot(bare ~ latitude, data=my.fractional, pch=20, bty="n")
points(ND$latitude, ND$predict , type="l", lwd=2, col="darkblue")
```

## Example 2: Species by sites table

Aside from 'gross' values from plots such as fractional cover, many analyses in community ecology begin with a species against sites table populated with abundance information. With ausplotsR you can generate this easily from the more complex vegetation point intercept hit data as follows:

```{r}
my.sppBYsites <- species_table(my.ausplots.data$veg.PI, m_kind="percent_cover", cover_type="PFC")
dim(my.sppBYsites) #the number of rows and columns in the matrix
my.sppBYsites[1:5, 1:5] #look at the top left corner (the matrix is large)

```

Here are simple examples of downstream analysis and visualisation uinsg the species occurrence matrix:

```{r, fig.height = 4, fig.width = 6}
#Whittaker plots:
goeveg::racurves(my.sppBYsites[10:15,], bw=F)
#With possible relative abundance models for one community:
plot(vegan::radfit(round(my.sppBYsites[10,], digits=0), log="xy"), pch=20)
```